\section{Business queries} % (fold)
\label{sub:Business queries}

\subsection*{Task} % (fold)
\label{sub:name}
For the designed data warehouse write 20 aggregation queries in both natural language and SQL. Include the results (if the resulting data amount is big, include a sample).
% subsection Task (end)

\subsection*{Subscription queries} % (fold)
\label{sub:Subscription business queries}
\begin{enumerate}
  \item Revenue from subscriptions by year.
  \begin{lstlisting}[language=sql]
	select sum(price * (1-discount) * quantity) revenue, d.year 
	from sub_subscription s 
	join sub_date d on s.keydate = d.keydate 
	group by d.year 
	order by year desc
  \end{lstlisting}
  \item Which were the most popular subscription periods each year?
  \begin{lstlisting}[language=sql]
	select year, p.name as period, sum(quantity) subscriptions
	from oplatek.sub_subscription s 
	join oplatek.sub_date d on s.keydate = d.keydate
	join oplatek.sub_period p on s.keyperiod = p.keyperiod 
	group by d.year, p.name
	order by year desc, subscriptions desc
  \end{lstlisting}
  \item Revenue from subscriptions and subscription count by country in 2010.
  \begin{lstlisting}[language=sql]
	  select l.country, sum(price * (1-discount) * quantity) revenue, sum(quantity) subscriptions 
	  from oplatek.sub_subscription s 
	  join oplatek.sub_location l on s.keylocation = l.keylocation 
	  join oplatek.sub_date d on s.keydate = d.keydate and d.year = 2010
	  group by l.country 
	  order by revenue desc
  \end{lstlisting}
  \item Top 10 cities from each country with the highest revenue from subscriptions in 2010.
  \begin{lstlisting}[language=sql]  
	select * from (select country, city, sum(price * (1-discount) * quantity) revenue, rank() over(partition by country order by sum(price * (1-discount) * quantity) desc) rank 
	from oplatek.sub_subscription s 
	join oplatek.sub_date d on s.keydate = d.keydate and d.year = 2010
	join oplatek.sub_location l on s.keylocation = l.keylocation
	group by l.country, l.city
	order by revenue desc)
	where rank <= 10
  \end{lstlisting}
  \item How much would we earn without applying discounts on subscriptions, by period type and by year?
  \begin{lstlisting}[language=sql] 
  	select year, period, revenue, revenue_no_discounts, (revenue_no_discounts - revenue) difference from 
	(select d.year, p.name as period, sum(price * (1-discount) * quantity) revenue, sum(price * quantity) revenue_no_discounts
	 from oplatek.sub_subscription s 
	 join oplatek.sub_date d on s.keydate = d.keydate
	 join oplatek.sub_period p on s.keyperiod = p.keyperiod
	 group by d.year, p.name)
	order by year desc, period asc
  \end{lstlisting}
  \item Number of sales on different holidays by period in Canada in 2010.
  \begin{lstlisting}[language=sql] 
	TODO
	select country, year, period, total_sales, 
	(select sum(quantity) from oplatek.sub_subscription ss, oplatek.sub_date dd where ss.keydate = dd.keydate and dd.christmas = 'Y' and ss.keyperiod = p.keyperiod and ss.keylocation = l.keylocation) as christmas,
	from (select l.country, d.year, p.name period, sum(quantity) total_sales
	from oplatek.sub_subscription s 
	join oplatek.sub_date d on s.keydate = d.keydate and d.year = 2010
	join oplatek.sub_location l on s.keylocation = l.keylocation and l.country = 'Canada'
	join oplatek.sub_period p on s.keyperiod = p.keyperiod 
	group by l.country, d.year, p.name)
	order by d.year, period
  \end{lstlisting}
  \item Revenue by month and by state in Canada in 2010 together with average revenue by states in Canada in the same month.
  \begin{lstlisting}[language=sql] 
	select l.state, d.month, sum(price * (1-discount) * quantity) revenue,
	avg(sum(price * (1-discount) * quantity)) over (partition by month) avg_rev /* avg_revenue_in_this_month_across_all_states */
	from oplatek.sub_subscription s 
	join oplatek.sub_location l on s.keylocation = l.keylocation and l.country = 'Canada' 
	join oplatek.sub_date d on s.keydate = d.keydate and d.year = 2010
	where length(l.state) = 2
	group by l.state, d.month
	order by state asc, month asc
  \end{lstlisting}
\end{enumerate}
% subsection Subscription queries (end)

\subsection*{Article queries} % (fold)
\label{sub:Article  queries}
\begin{enumerate}
\item    Top 10 read articles and author for every week in year 2011.
\item    Hours of the day when most articles are read, grouped by category in year 2010 + average number of articles read for the hour in year 2010
\item    Most read of articles by the day of week group by week together with avg num of articles read on this day of week
\item    Most commented authors group by category
\item    Each author’s most read articles with num of reads together with avg num of reads for this author’ s department and each author in this avg query has to have at least 20 articles and all these articles must be at least 1 month old
\item    The articles with  \#comments/ \#reads higher and average \#comments/\#reads by category having more reads  than 20000 and which are older than month group by category
\item    Comparing number of reads/shares/comments tagged with positive and negative group by year with ratio. Also the same with short/medium/long
\item    Most popular tags:  Top 100 tags which has the highest value of number of articles with tags divided with number with the tags.
\end{enumerate}
% subsection Article  queries (end)

\subsection*{Advertisement  queries} % (fold)
\label{sub:Advertisement queries}

\begin{enumerate}
\item    Revenue by year together with average revenue in all years together with revenue in this year and together with next year
  \begin{lstlisting}[language=sql] 
select ad.Year, sum(aa.revenue), avg(sum(aa.revenue)) over () AS total_avg 
      ,sum(sum(aa.revenue)) over (order by ad.year rows 1 preceding) AS sum_last_2_years
      from   
advert_advertisement aa
join advert_date ad on aa.keydate = ad.keydate
group by ad.YEAR;
  \end{lstlisting}
\item    CPM(Clicks divided by displays) for top 10 advertisers by revenue together with avg CPM for advertisers category having the advertiser at least 5 campaigns
  \begin{lstlisting}[language=sql] 
  \end{lstlisting}
\item    Revenue by advertiser category with revenue by limits 10k/20k/30/k
  \begin{lstlisting}[language=sql] 
  \end{lstlisting}
\item    The Campaigns which lasted more then 5 month with revenue bigger than 10000 per month
  \begin{lstlisting}[language=sql] 
  \end{lstlisting}
\item    Most popular campaigns by category and year together with avg CPM per month in this year for every month
  \begin{lstlisting}[language=sql] 
  \end{lstlisting}
\end{enumerate}
% section Business queries (end)

% section Advertisement business queries (end)
